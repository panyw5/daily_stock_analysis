---
name: analyze
description: 智能股票分析工具。支持一个或多个股票批量分析、实时进度反馈、分层报告展示、历史数据分析。当用户请求分析股票时使用。
---
# 工作流程

## 1. 解析用户输入

- 提取股票代码（支持多种格式）：
  * 纯代码: "600519"
  * 带名称: "贵州茅台(600519)"
  * 自然语言: "分析茅台"
- 识别分析模式：
  * 完整分析（默认）
  * 仅个股: `--no-market-review`
  * 仅大盘: `--market-review`
  * 个股历史数据分析: 使用 `history_analysis.py`

## 2. 前置检查

- 检查今日是否已有报告（`./reports/report_YYYYMMDD.md`）
- 如果存在，询问用户是否使用缓存或重新分析

## 3. 执行分析

### 日常分析（main.py）

- 构建命令: `python main.py --stocks 代码1,代码2 [选项]`
- 实时跟踪进度，向用户反馈：
  * "正在获取数据..."
  * "正在 AI 分析 (1/3)..."
  * "正在生成报告..."
- 预估时间: "预计需要 2-3 分钟"

### 历史数据分析（history_analysis.py）

当用户需要分析历史数据时，使用 `history_analysis.py`：

```bash
# 基础使用（默认近1月，AI 分析已启用）
python history_analysis.py --stock 600519

# 指定时间周期
python history_analysis.py --stock 600519 --period 3m

# 禁用 AI 分析（仅技术指标）
python history_analysis.py --stock 600519 --no-ai

# 批量分析
python history_analysis.py --stock 600519,000001 --period 1w
```

**AI 分析配置**：
- AI 分析功能默认启用
- 支持 Gemini API 或 OpenAI API（包括 OpenAI 兼容 API）
- 系统会优先使用 Gemini API，如果未配置会自动切换到 OpenAI API
- 如果不需要 AI 分析，可以使用 `--no-ai` 参数

**适用场景**：
- 用户要求查看"近3个月"、"近半年"等历史数据
- 用户要求分析特定日期范围的数据
- 用户要求查看历史走势和技术指标
- 用户要求进行历史回测

**支持的时间周期**：
- `5d` - 5天
- `1w` - 1周
- `2w` - 2周
- `1m` - 1月（默认）
- `3m` - 3月
- `6m` - 6月
- `1y` - 1年

## 4. 错误处理

如果命令失败：

- 读取错误日志（`./logs/stock_analysis_*.log`）
- 向用户解释原因并提供解决建议
- 常见问题：API Key 未配置、网络超时、股票代码无效

## 5. 报告呈现（分层展示）

### 第一层：核心摘要

用表格显示所有股票的：

- 操作建议（🟢买入/🟡观望/🔴卖出）
- 评分（0-100）
- 趋势预测
- 一句话结论

### 第二层：详细分析（用户询问时）

- 技术面数据（均线、乖离率、量能）
- 筹码分布（获利比例、集中度）
- 买卖点位（理想买入点、止损位、目标位）
- 风险提示和利好因素

### 第三层：完整报告

- 提供报告文件路径
- 用户可在 IDE 中打开查看

## 6. 交互式问答

分析完成后，使用 `cunzhi` 工具询问用户：

- 是否需要查看某只股票的详细分析？
- 是否需要了解技术指标含义？
- 是否需要分析其他股票？

# 7. 细节问题

详细配置和技术说明请参考 `REFERENCE.md`
