# 📊 股票分析系统 - 完整流程总结

> 本文档详细说明了股票分析系统的数据流转和处理流程

---

## 🎯 核心流程概览

```
用户输入股票代码
    ↓
【数据获取层】多数据源获取历史行情
    ↓
【增强数据层】实时行情 + 筹码分布 + 趋势分析
    ↓
【情报搜索层】多维度新闻搜索（华尔街见闻 + 其他搜索引擎）
    ↓
【AI 分析层】Gemini/OpenAI 综合分析
    ↓
【通知推送层】多渠道推送决策仪表盘
```

---

## 📥 一、数据获取层

### 1.1 历史行情数据源（优先级排序）

系统采用**策略模式**管理多个数据源，自动故障切换：

#### 配置了 TUSHARE_TOKEN 时：

| 优先级 | 数据源              | 说明                 | 特点                           |
| ------ | ------------------- | -------------------- | ------------------------------ |
| 0      | **TushareFetcher**  | Tushare Pro          | 专业金融数据，需注册获取 Token |
| 0      | **EfinanceFetcher** | 东方财富 efinance 库 | 免费，数据全面                 |
| 1      | **AkshareFetcher**  | AkShare 库           | 免费，接口丰富                 |
| 3      | **BaostockFetcher** | Baostock 库          | 免费，历史数据完整             |
| 4      | **YfinanceFetcher** | Yahoo Finance        | 支持美股/港股                  |

#### 未配置 TUSHARE_TOKEN 时：

| 优先级 | 数据源              | 说明       |
| ------ | ------------------- | ---------- |
| 0      | **EfinanceFetcher** | 最高优先级 |
| 1      | **AkshareFetcher**  | 次优先级   |
| 2      | TushareFetcher      | 不可用     |
| 3      | BaostockFetcher     | 备选       |
| 4      | YfinanceFetcher     | 备选       |

**数据字段**：

- 日期、开盘价、收盘价、最高价、最低价、成交量、成交额
- 涨跌幅、换手率等衍生指标

**获取周期**：默认获取最近 30 天数据

---

### 1.2 实时行情增强数据

通过 `AkshareFetcher` 获取实时增强数据：

| 数据类型     | 字段        | 说明                           |
| ------------ | ----------- | ------------------------------ |
| **实时行情** | 当前价格    | 最新成交价                     |
|              | 量比        | 当前成交量 / 过去5日平均成交量 |
|              | 换手率      | 成交量 / 流通股本              |
|              | 市盈率 (PE) | 股价 / 每股收益                |
|              | 市净率 (PB) | 股价 / 每股净资产              |
|              | 总市值      | 股价 × 总股本                  |
|              | 流通市值    | 股价 × 流通股本                |
|              | 60日涨跌幅  | 近2个月涨跌幅                  |
| **筹码分布** | 获利比例    | 当前价格下的获利盘比例         |
|              | 平均成本    | 市场平均持仓成本               |
|              | 90%集中度   | 90%筹码的价格区间              |
|              | 70%集中度   | 70%筹码的价格区间              |

**数据源优先级**：

```
akshare_sina → tencent → efinance → akshare_em
```

**缓存策略**：实时行情缓存 10 分钟（600秒）

---

### 1.3 趋势分析（基于交易理念）

通过 `StockTrendAnalyzer` 进行技术面分析：

#### 分析维度：

**1. 均线排列**

- MA5 > MA10 > MA20：多头排列 ✅
- MA5 < MA10 < MA20：空头排列 ❌
- 其他：震荡 ⚠️

**2. 乖离率**

- 乖离率 = (当前价 - MA) / MA × 100%
- 乖离率 > 5%：追高风险 ❌
- 乖离率 < -5%：超跌机会 ✅

**3. 量能分析**

- 量比 < 0.5：极度萎缩
- 量比 0.5-0.8：明显萎缩
- 量比 0.8-1.2：正常
- 量比 1.2-2.0：温和放量
- 量比 2.0-3.0：明显放量
- 量比 > 3.0：巨量

**4. 买入信号判断**

- ✅ **强烈买入**：多头排列 + 缩量回踩 MA5/MA10 + 乖离率安全
- ✅ **买入**：多头排列 + 乖离率安全
- 🟡 **观望**：震荡或乖离率过高
- ❌ **卖出**：空头排列或严重超买

---

## 🔍 二、情报搜索层

### 2.1 新闻数据源（优先级排序）

| 优先级 | 数据源         | 特点                        | 费用          | API Key    |
| ------ | -------------- | --------------------------- | ------------- | ---------- |
| 1      | **华尔街见闻** | 7x24 实时快讯，中文财经专业 | **完全免费**  | ❌ 无需配置 |
| 2      | **Tavily**     | AI 优化搜索，结构化结果     | 1000次/月免费 | ✅ 需配置   |
| 3      | **Exa**        | AI 语义搜索                 | 有免费额度    | ✅ 需配置   |
| 4      | **SerpAPI**    | Google 搜索结果             | 100次/月免费  | ✅ 需配置   |

### 2.2 多维度情报搜索策略

系统采用**三维度情报搜索**，全面覆盖风险和机会：

#### 搜索维度：

| 维度               | 搜索关键词                              | 目的         |
| ------------------ | --------------------------------------- | ------------ |
| **最新消息** | `{股票名称} {股票代码} 股票 最新消息` | 获取最新动态 |
| **风险排查** | `{股票名称} 减持 业绩下滑 风险 诉讼`  | 识别潜在风险 |
| **业绩预期** | `{股票名称} 业绩预告 年报 财报`       | 了解业绩情况 |

#### 重点关注关键词：

- **业绩相关**：年报预告、业绩预告、业绩快报
- **股东动向**：减持、增持、回购
- **机构动向**：机构调研、机构评级
- **消息面**：利好、利空
- **业务进展**：合同、订单、中标

### 2.3 华尔街见闻 API（免费）

**API 地址**：`https://api-prod.wallstreetcn.com/apiv1/content/lives`

**特点**：

- ✅ 完全免费，无需注册
- ✅ 实时更新，延迟低
- ✅ 专注中文财经新闻
- ✅ 系统已内置，开箱即用

**数据字段**：

- 标题、内容、发布时间
- 自动过滤相关性
- 返回最新 N 条快讯

---

## 🤖 三、AI 分析层

### 3.1 AI 模型配置（二选一）

| 模型                | 说明               | 费用             | 配置                                 |
| ------------------- | ------------------ | ---------------- | ------------------------------------ |
| **Google Gemini**   | 主力模型，推荐使用 | **免费额度充足** | `GEMINI_API_KEY`                     |
| **OpenAI 兼容 API** | 备选方案           | 按使用计费       | `OPENAI_API_KEY` + `OPENAI_BASE_URL` |

#### Gemini 模型选择：

- **主模型**：`gemini-3-flash-preview`（默认）
- **备选模型**：`gemini-2.5-flash`（主模型失败时自动切换）

#### OpenAI 兼容 API 支持：

- OpenAI GPT-4/GPT-3.5
- DeepSeek
- 通义千问（Qwen）
- Moonshot（月之暗面）
- 其他兼容 OpenAI API 格式的模型

### 3.2 分析输入数据

AI 分析器接收以下综合数据：

```python
{
    # 基础信息
    "code": "600519",
    "stock_name": "贵州茅台",
  
    # 历史行情（30天）
    "raw_data": [...],  # OHLCV 数据
  
    # 实时行情
    "realtime": {
        "price": 1850.00,
        "volume_ratio": 1.2,
        "turnover_rate": 0.5,
        "pe_ratio": 35.2,
        "pb_ratio": 12.5,
        "total_mv": 2300000000000,
        "circ_mv": 2300000000000,
        "change_60d": 5.2
    },
  
    # 筹码分布
    "chip": {
        "profit_ratio": 0.85,
        "avg_cost": 1750.00,
        "concentration_90": 0.15,
        "concentration_70": 0.10,
        "chip_status": "筹码集中"
    },
  
    # 趋势分析
    "trend_analysis": {
        "trend_status": "多头排列",
        "ma_alignment": true,
        "bias_ma5": 1.2,
        "bias_ma10": 3.5,
        "volume_status": "温和放量",
        "buy_signal": "买入",
        "signal_score": 85,
        "signal_reasons": ["多头排列", "缩量回踩MA5"],
        "risk_factors": []
    },
  
    # 新闻情报
    "news_context": "【最新消息搜索结果】\n1. 贵州茅台发布年报预告...\n..."
}
```

### 3.3 分析输出格式（决策仪表盘）

AI 返回结构化的决策仪表盘：

```json
{
    "code": "600519",
    "name": "贵州茅台",
    "sentiment_score": 85,
    "trend_prediction": "看多",
    "operation_advice": "买入",
    "confidence_level": "高",
  
    "dashboard": {
        "core_conclusion": {
            "one_sentence": "缩量回踩MA5支撑，乖离率1.2%处于最佳买点",
            "position_advice": {
                "no_position": "建议买入，目标价1900",
                "has_position": "持有，等待突破"
            }
        },
        "battle_plan": {
            "sniper_points": {
                "buy_price": "1800",
                "stop_loss": "1750",
                "target_price": "1900"
            },
            "action_checklist": [
                "✅ 多头排列",
                "✅ 乖离率安全",
                "✅ 量能配合"
            ]
        },
        "intelligence": {
            "risk_alerts": [
                "⚠️ 注意大盘走势"
            ]
        }
    }
}
```

### 3.4 交易理念融入

AI 分析遵循以下交易理念：

| 理念               | 实现方式                     |
| ------------------ | ---------------------------- |
| **严禁追高** | 乖离率 > 5% 自动标记「危险」 |
| **趋势交易** | 只做 MA5>MA10>MA20 多头排列  |
| **效率优先** | 关注筹码集中度好的股票       |
| **买点偏好** | 缩量回踩 MA5/MA10 支撑       |

---

## 📤 四、通知推送层

### 4.1 支持的通知渠道

系统支持**多渠道同时推送**：

| 渠道               | 配置项                                    | 说明          |
| ------------------ | ----------------------------------------- | ------------- |
| **企业微信**       | `WECHAT_WEBHOOK_URL`                      | Webhook 推送  |
| **飞书**           | `FEISHU_WEBHOOK_URL`                      | Webhook 推送  |
| **Telegram**       | `TELEGRAM_BOT_TOKEN` + `TELEGRAM_CHAT_ID` | Bot 推送      |
| **邮件**           | `EMAIL_SENDER` + `EMAIL_PASSWORD`         | SMTP 自动识别 |
| **PushPlus**       | `PUSHPLUS_TOKEN`                          | 国内推送服务  |
| **Discord**        | `DISCORD_WEBHOOK_URL`                     | Webhook 推送  |
| **自定义 Webhook** | `CUSTOM_WEBHOOK_URLS`                     | 支持钉钉等    |

### 4.2 推送内容格式

#### 决策仪表盘格式：

```
📊 2026-01-28 决策仪表盘
3只股票 | 🟢买入:1 🟡观望:2 🔴卖出:0

🟢 买入 | 贵州茅台(600519)
📌 缩量回踩MA5支撑，乖离率1.2%处于最佳买点
💰 狙击: 买入1800 | 止损1750 | 目标1900
✅多头排列 ✅乖离安全 ✅量能配合

🟡 观望 | 宁德时代(300750)
📌 乖离率7.8%超过5%警戒线，严禁追高
⚠️ 等待回调至MA5附近再考虑

---
生成时间: 18:00
```

### 4.3 推送模式

| 模式               | 配置                          | 说明                               |
| ------------------ | ----------------------------- | ---------------------------------- |
| **汇总推送** | `SINGLE_STOCK_NOTIFY=false` | 所有股票分析完后一次性推送（默认） |
| **单股推送** | `SINGLE_STOCK_NOTIFY=true`  | 每分析完一只股票立即推送           |

### 4.4 报告类型

| 类型             | 配置                   | 说明                       |
| ---------------- | ---------------------- | -------------------------- |
| **精简版** | `REPORT_TYPE=simple` | 仅核心结论和买卖点（默认） |
| **完整版** | `REPORT_TYPE=full`   | 包含详细技术分析和新闻摘要 |

---

## 🔄 五、完整流程示例

### 示例：分析贵州茅台（600519）

```
1. 【数据获取】
   ├─ EfinanceFetcher 获取30天历史数据 ✅
   ├─ 保存到 SQLite 数据库
   └─ 断点续传：今日数据已存在，跳过

2. 【增强数据】
   ├─ 实时行情：价格1850, 量比1.2, 换手率0.5% ✅
   ├─ 筹码分布：获利比例85%, 集中度15% ✅
   └─ 趋势分析：多头排列, 买入信号, 评分85 ✅

3. 【情报搜索】
   ├─ 华尔街见闻：获取5条最新快讯 ✅
   ├─ 风险排查：未发现减持/诉讼 ✅
   └─ 业绩预期：年报预告业绩增长 ✅

4. 【AI 分析】
   ├─ 模型：Gemini gemini-3-flash-preview
   ├─ 输入：历史数据 + 实时行情 + 筹码 + 趋势 + 新闻
   └─ 输出：决策仪表盘（买入，目标价1900）✅

5. 【通知推送】
   ├─ 企业微信：推送成功 ✅
   ├─ 飞书：推送成功 ✅
   └─ 本地报告：reports/dashboard_20260128.md ✅
```

---

## 📊 六、数据流转图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户输入                              │
│                    STOCK_LIST=600519                        │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据获取层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ EfinanceFetcher│→│ AkshareFetcher│→│ TushareFetcher│    │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│         ↓ 历史行情（30天 OHLCV）                            │
│  ┌──────────────────────────────────────────────────┐      │
│  │          SQLite 数据库（断点续传）                │      │
│  └──────────────────────────────────────────────────┘      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   增强数据层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  实时行情     │  │  筹码分布     │  │  趋势分析     │     │
│  │ (AkShare)    │  │ (AkShare)    │  │ (本地计算)    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│         ↓ 量比、换手率、PE/PB、筹码集中度、买入信号          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   情报搜索层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 华尔街见闻    │  │   Tavily     │  │   SerpAPI    │     │
│  │  (免费)      │  │ (1000次/月)  │  │ (100次/月)   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│         ↓ 最新消息 + 风险排查 + 业绩预期                     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    AI 分析层                                 │
│  ┌──────────────────────────────────────────────────┐      │
│  │         Google Gemini / OpenAI 兼容 API          │      │
│  │  输入：历史数据 + 实时行情 + 筹码 + 趋势 + 新闻   │      │
│  │  输出：决策仪表盘（评分、建议、点位、检查清单）   │      │
│  └──────────────────────────────────────────────────┘      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   通知推送层                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │ 企业微信  │ │   飞书    │ │ Telegram │ │   邮件    │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│         ↓ 决策仪表盘（Markdown/HTML）                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 七、核心优势总结

### 7.1 数据层面

- ✅ **多数据源冗余**：5个数据源自动切换，保证数据可靠性
- ✅ **实时增强数据**：量比、换手率、筹码分布等专业指标
- ✅ **断点续传**：避免重复获取，节省 API 配额

### 7.2 情报层面

- ✅ **完全免费**：华尔街见闻 7x24 快讯，无需配置
- ✅ **多维度搜索**：最新消息 + 风险排查 + 业绩预期
- ✅ **智能过滤**：关键词匹配，只返回相关新闻

### 7.3 分析层面

- ✅ **交易理念融入**：严禁追高、趋势交易、精确点位
- ✅ **决策仪表盘**：一句话结论 + 买卖点位 + 检查清单
- ✅ **多模型支持**：Gemini（免费）+ OpenAI 兼容 API

### 7.4 推送层面

- ✅ **多渠道推送**：支持 9 种通知渠道，可同时推送
- ✅ **格式优化**：Markdown 格式，易读易懂
- ✅ **灵活配置**：单股推送/汇总推送，精简版/完整版

---

## 📝 八、配置示例

### 最小配置（完全免费）

```bash
# AI 模型（必选）
GEMINI_API_KEY=your_gemini_api_key

# 自选股（必选）
STOCK_LIST=600519,000001,300750

# 通知渠道（至少一个）
WECHAT_WEBHOOK_URL=https://qyapi.weixin.qq.com/...
```

### 完整配置（推荐）

```bash
# AI 模型
GEMINI_API_KEY=your_gemini_api_key
GEMINI_MODEL=gemini-3-flash-preview
GEMINI_MODEL_FALLBACK=gemini-2.5-flash

# 数据源（可选）
TUSHARE_TOKEN=your_tushare_token

# 搜索引擎（可选，华尔街见闻已内置）
TAVILY_API_KEYS=key1,key2
SERPAPI_API_KEYS=key1,key2

# 自选股
STOCK_LIST=600519,000001,300750,hk00700,AAPL

# 通知渠道
WECHAT_WEBHOOK_URL=https://qyapi.weixin.qq.com/...
FEISHU_WEBHOOK_URL=https://open.feishu.cn/...
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id

# 推送配置
SINGLE_STOCK_NOTIFY=false
REPORT_TYPE=simple
```

---

## 🚀 九、运行方式

### 本地运行

```bash
python main.py
```

### GitHub Actions（自动运行）

- 默认每个工作日 18:00 自动执行
- 可手动触发：Actions → 每日股票分析 → Run workflow

### Docker 部署

```bash
docker-compose up -d
```

---

## 📚 十、相关文档

- [完整配置指南](full-guide.md)
- [华尔街见闻集成说明](wallstreetcn-integration.md)
- [贡献指南](CONTRIBUTING.md)

---

**最后更新**：2026-01-28
